# Workflow-Õ« Õ¡Õ¶Õ¸Ö‚Õ¶Õ¨
name: Build and Deploy

# ÔµÖ€Õ¢ Õ¯Õ¡Õ·Õ­Õ¡Õ¿Õ«
on:
  push:
    branches:
      - main

# Ô±Õ·Õ­Õ¡Õ¿Õ¡Õ¶Ö„Õ¶Õ¥Ö€
jobs:
  
  # ========================================
  # JOB 1: BUILD Ö‡ PUSH Docker Hub
  # ========================================
  build:
    name: ğŸ—ï¸ Build & Push
    runs-on: ubuntu-latest
    
    steps:
      # Õ”Õ¡ÕµÕ¬ 1: Õ†Õ¥Ö€Õ¢Õ¥Õ¼Õ¶Õ¥Õ¬ Õ¯Õ¸Õ¤Õ¨
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # Õ”Õ¡ÕµÕ¬ 2: Login Docker Hub
      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # Õ”Õ¡ÕµÕ¬ 3: Build Docker image
      - name: ğŸ—ï¸ Build image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/my-app:latest .
      
      # Õ”Õ¡ÕµÕ¬ 4: Push Docker Hub
      - name: ğŸš€ Push to Docker Hub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-app:latest
  
  # ========================================
  # JOB 2: DEPLOY Õ¿Õ¡Õ¶ Õ½Õ¥Ö€Õ¾Õ¥Ö€
  # ========================================
  deploy:
    name: ğŸš€ Deploy to Home Server
    runs-on: ubuntu-latest
    needs: build  # ÕÕºÕ¡Õ½Õ¥Õ¬ build job-Õ«Õ¶
    
    steps:
      # Õ”Õ¡ÕµÕ¬ 1: Deploy Õ½Õ¥Ö€Õ¾Õ¥Ö€Õ«Õ¶ SSH-Õ¸Õ¾
      - name: ğŸ  Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          fingerprint: ""
          script: |
            echo "ğŸš€ Starting deployment on home server..."
            
            # Pull Õ¾Õ¥Ö€Õ»Õ«Õ¶ image
            docker pull ${{ secrets.DOCKER_USERNAME }}/my-app:latest
            
            # Stop Ö‡ remove Õ°Õ«Õ¶ container
            docker stop my-app 2>/dev/null || true
            docker rm my-app 2>/dev/null || true
            
            # Start Õ¶Õ¸Ö€ container
            docker run -d \
              --name my-app \
              --restart unless-stopped \
              -p 80:80 \
              ${{ secrets.DOCKER_USERNAME }}/my-app:latest
            
            # ÕÕ¿Õ¸Ö‚Õ£Õ¥Õ¬ Õ¸Ö€ Õ¡Õ·Õ­Õ¡Õ¿Õ¸Ö‚Õ´ Õ§
            sleep 5
            if curl -f http://localhost:80 > /dev/null 2>&1; then
              echo "âœ… Deployment successful!"
            else
              echo "âŒ Deployment failed!"
              exit 1
            fi
      
      # Õ”Õ¡ÕµÕ¬ 2: Õ€Õ¡Õ»Õ¸Õ²Õ¸Ö‚Õ©ÕµÕ¡Õ¶ Õ°Õ¡Õ²Õ¸Ö€Õ¤Õ¡Õ£Ö€Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶
      - name: ğŸ‰ Success
        run: |
          echo "âœ… Application deployed to home server!"
          echo "ğŸŒ Access at: http://${{ secrets.SERVER_HOST }}:80"